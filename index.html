<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful Manager</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .printable-content { display: none; }
        @media print {
            body > * { display: none; }
            .printable-content {
                display: block !important;
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: auto;
                background: white;
            }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 font-sans antialiased text-gray-900">
    <div id="app" class="min-h-screen"></div>

    <script>
        // Use environment variables for Firebase configuration. DO NOT EDIT these lines.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let patients = [];
        let view = 'list';
        let selectedPatient = null;
        let doctorInfo = { name: 'Dr. John Doe', credentials: 'M.D.', contact: '555-555-5555' };
        let isGenerating = false;
        let isModalOpen = false;
        let modalContent = { title: '', text: '' };

        // Helper function for rendering elements
        function h(tag, props, ...children) {
            const element = document.createElement(tag);
            if (props) {
                Object.assign(element, props);
                for (const key in props) {
                    if (key.startsWith('on') && typeof props[key] === 'function') {
                        element.addEventListener(key.substring(2).toLowerCase(), props[key]);
                    } else if (key === 'className') {
                        element.className = props[key];
                    } else {
                        element.setAttribute(key, props[key]);
                    }
                }
            }
            children.forEach(child => {
                if (typeof child === 'string' || typeof child === 'number') {
                    element.appendChild(document.createTextNode(child));
                } else if (child) {
                    element.appendChild(child);
                }
            });
            return element;
        }

        // State management and rendering
        function updateUI() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            app.appendChild(render());
        }

        // Firebase Initialization and Authentication
        async function initializeFirebase() {
            try {
                const firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        try {
                            if (initialAuthToken) {
                                await auth.signInWithCustomToken(initialAuthToken);
                            } else {
                                await auth.signInAnonymously();
                            }
                        } catch (error) {
                            console.error("Firebase auth error:", error);
                            userId = 'auth-failed';
                        }
                    }
                    if (userId && userId !== 'auth-failed') {
                        setupDataListeners();
                    }
                    updateUI();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userId = 'auth-failed';
                updateUI();
            }
        }

        function setupDataListeners() {
            if (!db || !userId) return;
            const patientCollectionPath = `artifacts/${appId}/users/${userId}/patients`;
            db.collection(patientCollectionPath).onSnapshot(snapshot => {
                patients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            }, (error) => {
                console.error("Error fetching patients:", error);
                updateUI();
            });
        }

        // Event listeners for UI interactions
        function handleViewChange(newView, patient = null) {
            view = newView;
            selectedPatient = patient;
            updateUI();
        }

        async function handleAddPatient(patientData) {
            try {
                const patientCollectionPath = `artifacts/${appId}/users/${userId}/patients`;
                await db.collection(patientCollectionPath).add(patientData);
                handleViewChange('list');
            } catch (e) {
                console.error("Error adding patient: ", e);
            }
        }

        async function handleUpdatePatient(patientId, patientData) {
            try {
                const patientDocPath = `artifacts/${appId}/users/${userId}/patients/${patientId}`;
                await db.doc(patientDocPath).update(patientData);
                handleViewChange('list');
            } catch (e) {
                console.error("Error updating patient: ", e);
            }
        }

        async function handleDeletePatient(patientId) {
            try {
                const patientDocPath = `artifacts/${appId}/users/${userId}/patients/${patientId}`;
                await db.doc(patientDocPath).delete();
            } catch (e) {
                console.error("Error deleting patient: ", e);
            }
        }

        // Components as functions returning HTML elements
        function renderHeader() {
            const PlusCircle = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>`;
            const User = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;

            const header = h('header', { className: 'flex flex-col sm:flex-row justify-between items-center py-6 px-4 sm:px-8 bg-white shadow-md rounded-xl mb-6' },
                h('div', { className: 'flex items-center space-x-4 mb-4 sm:mb-0' },
                    h('h1', { className: 'text-3xl font-bold tracking-tight text-gray-800' }, 'Mindful Manager'),
                    h('p', { className: 'hidden md:block text-sm text-gray-500' }, 'Psychiatry Patient Management')
                ),
                h('div', { className: 'flex items-center space-x-2' },
                    h('button', {
                        onclick: () => handleViewChange('list'),
                        className: 'flex items-center px-4 py-2 bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-lg shadow-sm font-medium',
                        innerHTML: User() + '<span class="ml-2">All Patients</span>'
                    }),
                    h('button', {
                        onclick: () => handleViewChange('add'),
                        className: 'flex items-center px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg shadow-sm font-medium',
                        innerHTML: PlusCircle() + '<span class="ml-2">New Patient</span>'
                    })
                )
            );
            return header;
        }
        
        function renderPatientList() {
            const container = h('div', { className: 'rounded-xl bg-white shadow-lg p-6' });
            container.appendChild(h('h2', { className: 'text-2xl font-semibold' }, 'Patient Roster'));
            container.appendChild(h('p', { className: 'mt-1 text-sm text-gray-500' }, 'A complete list of your patients.'));

            if (patients.length === 0) {
                container.appendChild(h('p', { className: 'text-center text-gray-500 mt-4' }, 'No patients found. Add a new one to get started.'));
            } else {
                const list = h('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4' });
                patients.forEach(patient => {
                    const card = h('div', { className: 'rounded-lg border bg-white shadow-sm hover:shadow-lg transition-shadow duration-300' });
                    card.innerHTML = `
                        <div class="p-4">
                            <h3 class="text-lg font-semibold">${patient.name}</h3>
                            <p class="text-xs text-gray-500">DOB: ${patient.dob}</p>
                            <p class="text-sm mt-2">${patient.diagnosis}</p>
                            <div class="mt-4 flex justify-between items-center">
                                <button onclick="handleViewChange('details', patients.find(p => p.id === '${patient.id}'))" class="w-full rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">
                                    View Details
                                </button>
                            </div>
                        </div>
                    `;
                    list.appendChild(card);
                });
                container.appendChild(list);
            }
            return container;
        }

        function renderPatientForm(patient = null) {
            const formContainer = h('div', { className: 'rounded-xl bg-white shadow-lg p-6' });
            formContainer.appendChild(h('h2', { className: 'text-2xl font-semibold' }, patient ? 'Edit Patient' : 'Add New Patient'));
            formContainer.appendChild(h('p', { className: 'mt-1 text-sm text-gray-500' }, patient ? 'Update patient details.' : 'Fill out the form to add a new patient to your records.'));
            
            const form = h('form', {
                onsubmit: (e) => {
                    e.preventDefault();
                    const formData = {
                        name: document.getElementById('name').value,
                        dob: document.getElementById('dob').value,
                        diagnosis: document.getElementById('diagnosis').value,
                    };
                    if (patient) {
                        handleUpdatePatient(patient.id, formData);
                    } else {
                        handleAddPatient(formData);
                    }
                },
                className: 'space-y-4 mt-4'
            });

            form.innerHTML = `
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
                    <input id="name" type="text" value="${patient ? patient.name : ''}" required class="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium text-gray-700">Date of Birth</label>
                    <input id="dob" type="date" value="${patient ? patient.dob : ''}" required class="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="diagnosis" class="block text-sm font-medium text-gray-700">Diagnosis</label>
                    <textarea id="diagnosis" rows="3" class="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50">${patient ? patient.diagnosis : ''}</textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="handleViewChange('list')" class="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">Cancel</button>
                    <button type="submit" class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">${patient ? 'Update Patient' : 'Add Patient'}</button>
                </div>
            `;
            formContainer.appendChild(form);
            return formContainer;
        }

        // Render main content based on view state
        function renderMainContent() {
            if (!userId) {
                return h('div', { className: 'flex items-center justify-center min-h-[300px] text-xl font-semibold text-red-500' }, 'Authentication failed. Please try again.');
            }

            switch(view) {
                case 'list':
                    return renderPatientList();
                case 'add':
                    return renderPatientForm();
                case 'edit':
                    return renderPatientForm(selectedPatient);
                case 'details':
                    return renderPatientDetails(selectedPatient);
                default:
                    return h('div', { className: 'flex items-center justify-center min-h-[300px] text-xl font-semibold text-gray-700' }, 'Welcome to Mindful Manager.');
            }
        }

        function renderPatientDetails(patient) {
            const container = h('div', { className: 'rounded-xl bg-white shadow-lg p-6' });
            container.innerHTML = `
                <h2 class="text-2xl font-semibold">${patient.name}</h2>
                <p class="mt-1 text-sm text-gray-500">Patient Profile</p>
                <div class="mt-4 space-y-2">
                    <p><strong>Date of Birth:</strong> ${patient.dob}</p>
                    <p><strong>Diagnosis:</strong> ${patient.diagnosis}</p>
                </div>
                <div class="mt-6 flex space-x-2">
                    <button onclick="handleViewChange('edit', patients.find(p => p.id === '${patient.id}'))" class="rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">Edit Patient</button>
                    <button onclick="handleDeletePatient('${patient.id}')" class="rounded-lg bg-red-500 px-4 py-2 text-white hover:bg-red-600">Delete Patient</button>
                    <button onclick="handleViewChange('list')" class="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">Back to List</button>
                </div>
            `;
            return container;
        }

        // Full application render function
        function render() {
            const main = h('main', { className: 'container mx-auto max-w-5xl' });
            main.appendChild(h('p', { className: 'text-sm text-gray-500 mb-4' }, `User ID: ${userId}`));
            main.appendChild(renderMainContent());

            const body = h('div', { className: 'min-h-screen bg-gray-50 p-4 font-sans antialiased text-gray-900' });
            body.appendChild(renderHeader());
            body.appendChild(main);

            return body;
        }

        // Start the application after all DOM content is loaded
        window.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
        });
    </script>
</body>
</html>
