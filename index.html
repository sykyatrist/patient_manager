<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Psychiatry Patient Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-button {
            transition: all 0.3s ease;
        }
        @media print {
            body > div:not(.printable-content) {
                display: none;
            }
            .printable-content {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: auto;
                background: white;
            }
        }
    </style>
</head>
<body class="bg-gray-50 p-4 font-sans antialiased text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        const { initializeApp } = firebase.app;
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = firebase.auth;
        const { getFirestore, doc, collection, query, addDoc, updateDoc, deleteDoc, onSnapshot } = firebase.firestore;

        // Use environment variables for Firebase configuration. DO NOT EDIT these lines.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const firebaseApp = firebase.initializeApp(firebaseConfig);
                        const authInstance = firebase.auth(firebaseApp);
                        const dbInstance = firebase.firestore(firebaseApp);
                        setAuth(authInstance);
                        setDb(dbInstance);

                        const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else {
                                try {
                                    if (__initial_auth_token) {
                                        await signInWithCustomToken(authInstance, __initial_auth_token);
                                    } else {
                                        await signInAnonymously(authInstance);
                                    }
                                } catch (error) {
                                    console.error("Firebase auth error:", error);
                                }
                            }
                            setLoading(false);
                        });
                        return () => unsubscribe();
                    } catch (error) {
                        console.error("Firebase initialization failed:", error);
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            return (
                <AppContext.Provider value={{ db, auth, userId, loading }}>
                    {children}
                </AppContext.Provider>
            );
        };

        const App = () => {
            const { db, userId, loading, auth } = useContext(AppContext);
            const [patients, setPatients] = useState([]);
            const [view, setView] = useState('list');
            const [selectedPatient, setSelectedPatient] = useState(null);
            const [doctorInfo, setDoctorInfo] = useState({ name: 'Dr. John Doe', credentials: 'M.D.', contact: '555-555-5555' });
            const [firebaseInitError, setFirebaseInitError] = useState(false);

            const handleViewChange = (newView, patient = null) => {
                setView(newView);
                setSelectedPatient(patient);
            };

            useEffect(() => {
                if (!db || !userId) return;

                const patientCollectionPath = `artifacts/${appId}/users/${userId}/patients`;
                const patientRef = collection(db, patientCollectionPath);
                const q = query(patientRef);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const patientList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPatients(patientList);
                }, (error) => {
                    console.error("Error fetching patients:", error);
                });
                return () => unsubscribe();
            }, [db, userId]);

            const handleAddPatient = async (id, patientData) => {
                try {
                    const patientCollectionPath = `artifacts/${appId}/users/${userId}/patients`;
                    await addDoc(collection(db, patientCollectionPath), patientData);
                    handleViewChange('list');
                } catch (e) {
                    console.error("Error adding patient: ", e);
                }
            };

            const handleUpdatePatient = async (patientId, patientData) => {
                try {
                    const patientDocPath = `artifacts/${appId}/users/${userId}/patients/${patientId}`;
                    await updateDoc(doc(db, patientDocPath), patientData);
                    handleViewChange('list');
                } catch (e) {
                    console.error("Error updating patient: ", e);
                }
            };

            const handleDeletePatient = async (patientId) => {
                try {
                    const patientDocPath = `artifacts/${appId}/users/${userId}/patients/${patientId}`;
                    await deleteDoc(doc(db, patientDocPath));
                } catch (e) {
                    console.error("Error deleting patient: ", e);
                }
            };

            const renderContent = () => {
                if (loading) {
                    return <div className="flex items-center justify-center min-h-[300px] text-xl font-semibold text-gray-700">Loading...</div>;
                }
                if (firebaseInitError || !db || !auth) {
                    return <div className="flex items-center justify-center min-h-[300px] text-xl font-semibold text-red-500">
                        Error: Firebase is not configured correctly.
                    </div>;
                }
                if (!userId) {
                    return <div className="flex items-center justify-center min-h-[300px] text-xl font-semibold text-red-500">Authentication failed. Please try again.</div>;
                }
                switch (view) {
                    case 'list':
                        return <PatientList patients={patients} setView={handleViewChange} handleDeletePatient={handleDeletePatient} />;
                    case 'add':
                        return <PatientForm onSave={handleAddPatient} setView={handleViewChange} />;
                    case 'details':
                        return <PatientDetails patient={selectedPatient} setView={handleViewChange} doctorInfo={doctorInfo} setDoctorInfo={setDoctorInfo} />;
                    case 'edit':
                        return <PatientForm patient={selectedPatient} onSave={handleUpdatePatient} setView={handleViewChange} />;
                    case 'prescriptions':
                        return <PrescriptionForm patient={selectedPatient} setView={handleViewChange} doctorInfo={doctorInfo} />;
                    case 'settings':
                        return <SettingsForm doctorInfo={doctorInfo} setDoctorInfo={setDoctorInfo} setView={handleViewChange} />;
                    default:
                        return null;
                }
            };

            const PlusCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>;
            const User = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;

            return (
                <div className="min-h-screen">
                    <header className="flex flex-col sm:flex-row justify-between items-center py-6 px-4 sm:px-8 bg-white shadow-md rounded-xl mb-6">
                        <div className="flex items-center space-x-4 mb-4 sm:mb-0">
                            <h1 className="text-3xl font-bold tracking-tight text-gray-800">Mindful Manager</h1>
                            <p className="hidden md:block text-sm text-gray-500">Psychiatry Patient Management</p>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button onClick={() => { handleViewChange('list'); }} className="flex items-center px-4 py-2 bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-lg shadow-sm font-medium">
                                <User /> <span className="ml-2">All Patients</span>
                            </button>
                            <button onClick={() => handleViewChange('add')} className="flex items-center px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg shadow-sm font-medium">
                                <PlusCircle /> <span className="ml-2">New Patient</span>
                            </button>
                        </div>
                    </header>
                    <main className="container mx-auto max-w-5xl">
                        <p className="text-sm text-gray-500 mb-4">User ID: <span className="font-mono text-xs bg-gray-200 rounded-md px-2 py-1 select-all">{userId}</span></p>
                        {renderContent()}
                    </main>
                </div>
            );
        };

        const PatientList = ({ patients, setView, handleDeletePatient }) => {
            const ConfirmationDialog = ({ onConfirm, children }) => {
                const [open, setOpen] = useState(false);
                return (
                    <>
                        <div onClick={() => setOpen(true)} className="inline-block cursor-pointer">
                            {children}
                        </div>
                        {open && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 p-4">
                                <div className="w-full max-w-sm rounded-lg bg-white p-6 shadow-lg">
                                    <h3 className="mb-2 text-xl font-semibold">Confirm Deletion</h3>
                                    <p className="mb-4 text-gray-500">Are you sure you want to delete this patient? This action cannot be undone.</p>
                                    <div className="flex justify-end space-x-2">
                                        <button onClick={() => setOpen(false)} className="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">Cancel</button>
                                        <button onClick={() => { onConfirm(); setOpen(false); }} className="rounded-lg bg-red-600 px-4 py-2 text-white hover:bg-red-700">Delete</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </>
                );
            };
            const Pencil = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
            const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;

            return (
                <div className="rounded-xl bg-white shadow-lg">
                    <div className="p-6">
                        <h2 className="text-2xl font-semibold">Patient Roster</h2>
                        <p className="mt-1 text-sm text-gray-500">A complete list of your patients.</p>
                    </div>
                    <div className="p-6 pt-0">
                        {patients.length === 0 ? (
                            <p className="text-center text-gray-500">No patients found. Add a new one to get started.</p>
                        ) : (
                            <div className="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
                                {patients.map(patient => (
                                    <div key={patient.id} className="rounded-lg border bg-white shadow-sm transition-shadow duration-300 hover:shadow-lg">
                                        <div className="flex items-start justify-between p-4 pb-2">
                                            <div>
                                                <h3 className="text-lg font-semibold">{patient.name}</h3>
                                                <p className="text-xs text-gray-500">DOB: {patient.dob}</p>
                                            </div>
                                            <div className="flex space-x-1">
                                                <button onClick={() => setView('edit', patient)} className="h-auto rounded-lg bg-transparent p-2 text-gray-500 hover:bg-gray-100 hover:text-blue-600">
                                                    <Pencil />
                                                </button>
                                                <ConfirmationDialog onConfirm={() => handleDeletePatient(patient.id)}>
                                                    <button className="h-auto rounded-lg bg-transparent p-2 text-gray-500 hover:bg-gray-100 hover:text-red-600">
                                                        <Trash2 />
                                                    </button>
                                                </ConfirmationDialog>
                                            </div>
                                        </div>
                                        <div className="px-6 py-2">
                                            <p className="text-sm">{patient.diagnosis}</p>
                                        </div>
                                        <div className="p-6 pt-2">
                                            <button onClick={() => setView('details', patient)} className="w-full rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">
                                                View Details
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PatientForm = ({ patient, onSave, setView }) => {
            const [formData, setFormData] = useState(patient || { name: '', dob: '', diagnosis: '' });
            const handleChange = (e) => {
                const { id, value } = e.target;
                setFormData({ ...formData, [id]: value });
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(patient ? patient.id : null, formData);
            };
            return (
                <div className="rounded-xl bg-white shadow-lg">
                    <div className="p-6">
                        <h2 className="text-2xl font-semibold">{patient ? 'Edit Patient' : 'Add New Patient'}</h2>
                        <p className="mt-1 text-sm text-gray-500">{patient ? 'Update patient details.' : 'Fill out the form to add a new patient to your records.'}</p>
                    </div>
                    <form onSubmit={handleSubmit}>
                        <div className="space-y-4 p-6 pt-0">
                            <div>
                                <label htmlFor="name" className="mb-1 block text-sm font-medium text-gray-700">Name</label>
                                <input id="name" type="text" value={formData.name} onChange={handleChange} required className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" />
                            </div>
                            <div>
                                <label htmlFor="dob" className="mb-1 block text-sm font-medium text-gray-700">Date of Birth</label>
                                <input id="dob" type="date" value={formData.dob} onChange={handleChange} required className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" />
                            </div>
                            <div>
                                <label htmlFor="diagnosis" className="mb-1 block text-sm font-medium text-gray-700">Diagnosis</label>
                                <textarea id="diagnosis" value={formData.diagnosis} onChange={handleChange} rows="3" className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" />
                            </div>
                        </div>
                        <div className="flex justify-end space-x-2 p-6">
                            <button type="button" onClick={() => setView('list')} className="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">Cancel</button>
                            <button type="submit" className="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">{patient ? 'Update Patient' : 'Add Patient'}</button>
                        </div>
                    </form>
                </div>
            );
        };

        const PatientDetails = ({ patient, setView, doctorInfo, setDoctorInfo }) => {
            const [tab, setTab] = useState('notes');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ title: '', text: '' });
            const [isLoadingModal, setIsLoadingModal] = useState(false);
            const { db, userId } = useContext(AppContext);
            const userIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
            const magicSparkle = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m4.93 19.07 1.41-1.41"/><path d="m17.66 6.34 1.41-1.41"/><path d="M16 12a4 4 0 1 1-8 0 4 4 0 0 1 8 0z"/></svg>;
            const handleOpenModal = (title, text) => {
                setModalContent({ title, text });
                setIsModalOpen(true);
            };
            const handleCloseModal = () => {
                setIsModalOpen(false);
                setModalContent({ title: '', text: '' });
            };
            const generateReferralLetter = async () => {
                setIsLoadingModal(true);
                handleOpenModal("Generating Referral Letter...", "");
                const systemPrompt = `You are a professional medical assistant drafting a referral letter for ${doctorInfo.name}. Write a concise, professional, and well-structured referral letter for a patient based on the provided clinical information. The letter should be addressed to a hypothetical colleague and include the patient's name, DOB, a brief clinical summary, and a clear reason for the referral. Do not include your own opinions or information outside of the provided context.`;
                const userQuery = `Draft a referral letter for the following patient: Patient Name: ${patient.name} Date of Birth: ${patient.dob} Diagnosis: ${patient.diagnosis} Reason for referral: The patient requires specialized care for their diagnosis, specifically for medication management and long-term treatment.`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating letter. Please try again.";
                    handleOpenModal("Generated Referral Letter", text);
                } catch (error) {
                    console.error("API call failed:", error);
                    handleOpenModal("Error", "Failed to generate referral letter due to an API error.");
                } finally {
                    setIsLoadingModal(false);
                }
            };
            return (
                <div className="rounded-xl bg-white shadow-lg">
                    <div className="p-6">
                        <h2 className="flex items-center text-2xl font-semibold">
                            {userIcon({})} {patient.name}
                        </h2>
                        <p className="mt-1 text-sm text-gray-500">
                            Patient Profile and Administrative Records
                        </p>
                        <div className="mt-4 flex space-x-2 border-b border-gray-200">
                            <button onClick={() => setTab('notes')} className={`-mb-px px-4 py-2 text-sm font-medium border-b-2 ${tab === 'notes' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Session Notes</button>
                            <button onClick={() => setTab('medications')} className={`-mb-px px-4 py-2 text-sm font-medium border-b-2 ${tab === 'medications' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Medications</button>
                            <button onClick={() => setTab('billing')} className={`-mb-px px-4 py-2 text-sm font-medium border-b-2 ${tab === 'billing' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Billing</button>
                            <button onClick={() => setTab('appointments')} className={`-mb-px px-4 py-2 text-sm font-medium border-b-2 ${tab === 'appointments' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Appointments</button>
                            <button onClick={() => setTab('summary')} className={`-mb-px px-4 py-2 text-sm font-medium border-b-2 ${tab === 'summary' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Case Summary</button>
                            <button onClick={() => setTab('settings')} className={`-mb-px px-4 py-2 text-sm font-medium border-b-2 ${tab === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Settings</button>
                            <button onClick={generateReferralLetter} disabled={isLoadingModal} className={`flex items-center rounded-lg px-4 py-2 text-sm font-medium transition-colors ${isLoadingModal ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-purple-600 text-white hover:bg-purple-700'}`}>
                                {magicSparkle({})} Generate Referral ✨
                            </button>
                        </div>
                    </div>
                    <div className="p-6 pt-0">
                        {tab === 'notes' && <SessionNotesSection patient={patient} doctorInfo={doctorInfo} />}
                        {tab === 'medications' && <MedicationSection patient={patient} setView={setView} />}
                        {tab === 'billing' && <BillingSection patient={patient} />}
                        {tab === 'appointments' && <AppointmentsSection patient={patient} />}
                        {tab === 'summary' && <CaseSummarySection patient={patient} />}
                        {tab === 'settings' && <SettingsForm doctorInfo={doctorInfo} setDoctorInfo={setDoctorInfo} />}
                    </div>
                    <div className="p-6">
                        <button onClick={() => setView('list')} className="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">
                            Back to List
                        </button>
                    </div>
                    {isModalOpen && (
                        <Modal title={modalContent.title} text={modalContent.text} onClose={handleCloseModal} isLoading={isLoadingModal} />
                    )}
                </div>
            );
        };

        const Modal = ({ title, text, onClose, isLoading }) => {
            const [copyStatus, setCopyStatus] = useState("Copy");
            const copyToClipboard = () => {
                navigator.clipboard.writeText(text).then(() => {
                    setCopyStatus("Copied!");
                    setTimeout(() => setCopyStatus("Copy"), 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    setCopyStatus("Failed to copy");
                });
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 p-4">
                    <div className="w-full max-w-lg rounded-lg bg-white p-6 shadow-lg">
                        <h3 className="mb-2 text-xl font-semibold">{title}</h3>
                        <div className="mb-4 max-h-96 overflow-y-auto">
                            {isLoading ? (
                                <div className="text-center text-gray-500">Loading...</div>
                            ) : (
                                <p className="whitespace-pre-wrap text-sm text-gray-800">{text}</p>
                            )}
                        </div>
                        <div className="flex justify-end space-x-2">
                            <button onClick={onClose} className="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">Close</button>
                            <button onClick={copyToClipboard} className="rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700">{copyStatus}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SessionNotesSection = ({ patient, doctorInfo }) => {
            const { db, userId } = useContext(AppContext);
            const [notes, setNotes] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ title: '', text: '' });
            const [isLoadingModal, setIsLoadingModal] = useState(false);
            const handleOpenModal = (title, text) => {
                setModalContent({ title, text });
                setIsModalOpen(true);
            };
            const handleCloseModal = () => {
                setIsModalOpen(false);
                setModalContent({ title: '', text: '' });
            };
            useEffect(() => {
                if (!db || !userId || !patient) return;
                const notesCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/sessions`;
                const notesRef = collection(db, notesCollectionPath);
                const q = query(notesRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const notesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setNotes(notesList.sort((a, b) => new Date(b.timestamp.toDate()) - new Date(a.timestamp.toDate())));
                }, (error) => {
                    console.error("Error fetching notes:", error);
                });
                return () => unsubscribe();
            }, [db, userId, patient]);

            const handleAddNote = async (noteText) => {
                try {
                    const notesCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/sessions`;
                    await addDoc(collection(db, notesCollectionPath), {
                        note: noteText,
                        date: new Date().toISOString().slice(0, 10),
                        timestamp: new Date(),
                    });
                } catch (e) {
                    console.error("Error adding note: ", e);
                }
            };
            const handleDeleteNote = async (noteId) => {
                try {
                    const noteDocPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/sessions/${noteId}`;
                    await deleteDoc(doc(db, noteDocPath));
                } catch (e) {
                    console.error("Error deleting note: ", e);
                }
            };
            const generateTreatmentPlan = async () => {
                setIsLoadingModal(true);
                handleOpenModal("Generating Treatment Plan...", "");
                const allNotes = notes.map(note => `[Note from ${note.date}]\n${note.note}`).join("\n\n");
                const systemPrompt = `You are an expert mental health professional, Dr. ${doctorInfo.name}. Based on the provided patient diagnosis and session notes, generate a well-structured and comprehensive treatment plan. The plan should include long-term and short-term goals, recommended interventions, and potential follow-up actions. Ensure the tone is clinical and professional. Do not include your own opinions or information outside of the provided context.`;
                const userQuery = `Generate a treatment plan for a patient named ${patient.name} with the diagnosis of ${patient.diagnosis}. Here are the session notes to inform the plan:\n\n${allNotes}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating plan. Please try again.";
                    handleOpenModal("Generated Treatment Plan", text);
                } catch (error) {
                    console.error("API call failed:", error);
                    handleOpenModal("Error", "Failed to generate treatment plan due to an API error.");
                } finally {
                    setIsLoadingModal(false);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="rounded-lg bg-gray-50 p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">New Session Note</h3>
                        <NoteForm onSave={handleAddNote} />
                        <button onClick={generateTreatmentPlan} disabled={isLoadingModal} className={`mt-4 w-full flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium transition-colors ${isLoadingModal ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}`}>
                            {isLoadingModal ? 'Generating...' : 'Generate Treatment Plan'}
                        </button>
                    </div>
                    <div className="space-y-4">
                        {notes.length === 0 ? (
                            <p className="text-center text-gray-500">No session notes found.</p>
                        ) : (
                            notes.map(note => (
                                <NoteCard key={note.id} note={note} onDelete={() => handleDeleteNote(note.id)} />
                            ))
                        )}
                    </div>
                    {isModalOpen && (
                        <Modal title={modalContent.title} text={modalContent.text} onClose={handleCloseModal} isLoading={isLoadingModal} />
                    )}
                </div>
            );
        };

        const NoteForm = ({ onSave }) => {
            const [noteText, setNoteText] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (noteText.trim()) {
                    onSave(noteText);
                    setNoteText('');
                }
            };
            return (
                <form onSubmit={handleSubmit} className="mt-4">
                    <textarea
                        value={noteText}
                        onChange={(e) => setNoteText(e.target.value)}
                        rows="4"
                        placeholder="Enter session notes here..."
                        className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50"
                    />
                    <button type="submit" className="mt-3 rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">Add Note</button>
                </form>
            );
        };

        const NoteCard = ({ note, onDelete }) => {
            const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
            return (
                <div className="rounded-lg bg-white p-6 shadow-sm">
                    <div className="flex justify-between items-center">
                        <p className="text-sm font-semibold text-gray-500">{note.date}</p>
                        <button onClick={onDelete} className="p-1 rounded-lg hover:bg-gray-100">
                            <Trash2 />
                        </button>
                    </div>
                    <p className="mt-2 text-gray-800 whitespace-pre-wrap">{note.note}</p>
                </div>
            );
        };

        const MedicationSection = ({ patient, setView }) => {
            const { db, userId } = useContext(AppContext);
            const [medications, setMedications] = useState([]);
            const [newMedication, setNewMedication] = useState({ name: '', dosage: '', frequency: '' });
            useEffect(() => {
                if (!db || !userId || !patient) return;
                const medCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/medications`;
                const medRef = collection(db, medCollectionPath);
                const q = query(medRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const medList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMedications(medList);
                }, (error) => {
                    console.error("Error fetching medications:", error);
                });
                return () => unsubscribe();
            }, [db, userId, patient]);

            const handleAddMedication = async (e) => {
                e.preventDefault();
                if (!newMedication.name) return;
                try {
                    const medCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/medications`;
                    await addDoc(collection(db, medCollectionPath), { ...newMedication, timestamp: new Date() });
                    setNewMedication({ name: '', dosage: '', frequency: '' });
                } catch (e) {
                    console.error("Error adding medication: ", e);
                }
            };
            const handleDeleteMedication = async (medId) => {
                try {
                    const medDocPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/medications/${medId}`;
                    await deleteDoc(doc(db, medDocPath));
                } catch (e) {
                    console.error("Error deleting medication: ", e);
                }
            };
            const handleGeneratePrescription = () => {
                setView('prescriptions');
            };
            const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
            return (
                <div className="space-y-6">
                    <div className="rounded-lg bg-gray-50 p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">Add New Medication</h3>
                        <form onSubmit={handleAddMedication} className="mt-4 space-y-3">
                            <input type="text" value={newMedication.name} onChange={(e) => setNewMedication({...newMedication, name: e.target.value})} placeholder="Medication Name" required className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <input type="text" value={newMedication.dosage} onChange={(e) => setNewMedication({...newMedication, dosage: e.target.value})} placeholder="Dosage (e.g., 10mg)" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <input type="text" value={newMedication.frequency} onChange={(e) => setNewMedication({...newMedication, frequency: e.target.value})} placeholder="Frequency (e.g., once daily)" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <button type="submit" className="w-full rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">Add Medication</button>
                        </form>
                    </div>
                    <div className="rounded-lg bg-white p-6 shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold text-gray-800">Current Medications</h3>
                            <button onClick={handleGeneratePrescription} className="rounded-lg bg-blue-500 px-4 py-2 text-white hover:bg-blue-600">Generate Prescription</button>
                        </div>
                        <ul className="space-y-3">
                            {medications.length === 0 ? (
                                <p className="text-gray-500">No medications listed.</p>
                            ) : (
                                medications.map(med => (
                                    <li key={med.id} className="flex justify-between items-center rounded-lg bg-gray-50 p-4 shadow-sm">
                                        <div>
                                            <h4 className="font-medium">{med.name}</h4>
                                            <p className="text-sm text-gray-600">{med.dosage} - {med.frequency}</p>
                                        </div>
                                        <button onClick={() => handleDeleteMedication(med.id)} className="p-1 rounded-lg hover:bg-gray-100">
                                            <Trash2 />
                                        </button>
                                    </li>
                                ))
                            )}
                        </ul>
                    </div>
                </div>
            );
        };

        const PrescriptionForm = ({ patient, doctorInfo, setView }) => {
            const [prescriptionData, setPrescriptionData] = useState({
                medication: '',
                dosage: '',
                quantity: '',
                refills: '',
                instructions: '',
            });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setPrescriptionData({ ...prescriptionData, [name]: value });
            };
            const handlePrint = () => {
                window.print();
            };
            const handleGoBack = () => {
                setView('medications');
            };
            return (
                <div className="rounded-xl bg-white shadow-lg p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-semibold">Prescription Generator</h2>
                        <div className="space-x-2">
                            <button onClick={handleGoBack} className="rounded-lg bg-gray-200 px-4 py-2 text-gray-700 hover:bg-gray-300">
                                Back
                            </button>
                            <button onClick={handlePrint} className="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">
                                Print Prescription
                            </button>
                        </div>
                    </div>
                    <div className="printable-content border border-gray-300 rounded-lg p-8">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-xl font-bold">{doctorInfo.name}</h1>
                                <p className="text-sm">{doctorInfo.credentials}</p>
                                <p className="text-sm text-gray-600">{doctorInfo.contact}</p>
                            </div>
                            <p className="text-sm text-gray-500">Date: {new Date().toLocaleDateString()}</p>
                        </div>
                        <div className="mt-6 border-b border-gray-300 pb-4">
                            <p className="font-semibold">Patient Information:</p>
                            <p className="text-sm">Name: {patient.name}</p>
                            <p className="text-sm">DOB: {patient.dob}</p>
                        </div>
                        <div className="mt-6 space-y-4">
                            <div className="flex items-center space-x-2">
                                <span className="text-2xl">℞</span>
                                <input type="text" name="medication" value={prescriptionData.medication} onChange={handleChange} placeholder="Medication Name" className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Dosage</label>
                                <input type="text" name="dosage" value={prescriptionData.dosage} onChange={handleChange} placeholder="e.g., 10mg" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Quantity</label>
                                <input type="text" name="quantity" value={prescriptionData.quantity} onChange={handleChange} placeholder="e.g., 30 tablets" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Refills</label>
                                <input type="text" name="refills" value={prescriptionData.refills} onChange={handleChange} placeholder="e.g., 3" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Instructions (Sig)</label>
                                <textarea name="instructions" value={prescriptionData.instructions} onChange={handleChange} placeholder="e.g., Take one tablet by mouth daily in the morning." rows="2" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            </div>
                        </div>
                        <div className="mt-8 border-t border-gray-300 pt-4">
                            <p className="text-xs text-gray-500">
                                This form is not a valid prescription. Please verify all information before issuing a final prescription.
                            </p>
                            <div className="flex justify-between items-center mt-4">
                                <div className="text-sm">DEA No. XXX-XXX-XXX</div>
                                <div className="text-lg font-bold">Signature: _______________________</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BillingSection = ({ patient }) => {
            const { db, userId } = useContext(AppContext);
            const [bills, setBills] = useState([]);
            const [newBill, setNewBill] = useState({ date: new Date().toISOString().slice(0, 10), service: '', amount: '' });
            useEffect(() => {
                if (!db || !userId || !patient) return;
                const billsCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/billing`;
                const billsRef = collection(db, billsCollectionPath);
                const q = query(billsRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const billList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBills(billList.sort((a, b) => new Date(b.date) - new Date(a.date)));
                }, (error) => {
                    console.error("Error fetching billing data:", error);
                });
                return () => unsubscribe();
            }, [db, userId, patient]);

            const handleAddBill = async (e) => {
                e.preventDefault();
                if (!newBill.service || !newBill.amount) return;
                try {
                    const billsCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/billing`;
                    await addDoc(collection(db, billsCollectionPath), newBill);
                    setNewBill({ date: new Date().toISOString().slice(0, 10), service: '', amount: '' });
                } catch (e) {
                    console.error("Error adding bill: ", e);
                }
            };
            const handleDeleteBill = async (billId) => {
                try {
                    const billDocPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/billing/${billId}`;
                    await deleteDoc(doc(db, billDocPath));
                } catch (e) {
                    console.error("Error deleting bill: ", e);
                }
            };
            const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
            return (
                <div className="space-y-6">
                    <div className="rounded-lg bg-gray-50 p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">Add New Bill</h3>
                        <form onSubmit={handleAddBill} className="mt-4 space-y-3">
                            <input type="date" value={newBill.date} onChange={(e) => setNewBill({ ...newBill, date: e.target.value })} required className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <input type="text" value={newBill.service} onChange={(e) => setNewBill({ ...newBill, service: e.target.value })} placeholder="Service Provided" required className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <input type="number" value={newBill.amount} onChange={(e) => setNewBill({ ...newBill, amount: e.target.value })} placeholder="Amount ($)" required className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <button type="submit" className="w-full rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">Add Bill</button>
                        </form>
                    </div>
                    <div className="rounded-lg bg-white p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">Billing History</h3>
                        <ul className="mt-4 space-y-3">
                            {bills.length === 0 ? (
                                <p className="text-gray-500">No billing records found.</p>
                            ) : (
                                bills.map(bill => (
                                    <li key={bill.id} className="flex justify-between items-center rounded-lg bg-gray-50 p-4 shadow-sm">
                                        <div>
                                            <h4 className="font-medium text-gray-800">{bill.service}</h4>
                                            <p className="text-sm text-gray-600">{bill.date} - ${bill.amount}</p>
                                        </div>
                                        <button onClick={() => handleDeleteBill(bill.id)} className="p-1 rounded-lg hover:bg-gray-100">
                                            <Trash2 />
                                        </button>
                                    </li>
                                ))
                            )}
                        </ul>
                    </div>
                </div>
            );
        };

        const AppointmentsSection = ({ patient }) => {
            const { db, userId } = useContext(AppContext);
            const [appointments, setAppointments] = useState([]);
            const [newAppointment, setNewAppointment] = useState({ date: new Date().toISOString().slice(0, 10), time: '', description: '' });
            useEffect(() => {
                if (!db || !userId || !patient) return;
                const apptsCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/appointments`;
                const apptsRef = collection(db, apptsCollectionPath);
                const q = query(apptsRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const apptList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAppointments(apptList.sort((a, b) => new Date(b.date) - new Date(a.date)));
                }, (error) => {
                    console.error("Error fetching appointments:", error);
                });
                return () => unsubscribe();
            }, [db, userId, patient]);

            const handleAddAppointment = async (e) => {
                e.preventDefault();
                if (!newAppointment.date || !newAppointment.time) return;
                try {
                    const apptsCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/appointments`;
                    await addDoc(collection(db, apptsCollectionPath), newAppointment);
                    setNewAppointment({ date: new Date().toISOString().slice(0, 10), time: '', description: '' });
                } catch (e) {
                    console.error("Error adding appointment: ", e);
                }
            };
            const handleDeleteAppointment = async (apptId) => {
                try {
                    const apptDocPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/appointments/${apptId}`;
                    await deleteDoc(doc(db, apptDocPath));
                } catch (e) {
                    console.error("Error deleting appointment: ", e);
                }
            };
            const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
            return (
                <div className="space-y-6">
                    <div className="rounded-lg bg-gray-50 p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">Schedule New Appointment</h3>
                        <form onSubmit={handleAddAppointment} className="mt-4 space-y-3">
                            <input type="date" value={newAppointment.date} onChange={(e) => setNewAppointment({ ...newAppointment, date: e.target.value })} required className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <input type="time" value={newAppointment.time} onChange={(e) => setNewAppointment({ ...newAppointment, time: e.target.value })} required className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <input type="text" value={newAppointment.description} onChange={(e) => setNewAppointment({ ...newAppointment, description: e.target.value })} placeholder="Description (e.g., Follow-up session)" className="w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900" />
                            <button type="submit" className="w-full rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">Schedule Appointment</button>
                        </form>
                    </div>
                    <div className="rounded-lg bg-white p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">Upcoming Appointments</h3>
                        <ul className="mt-4 space-y-3">
                            {appointments.length === 0 ? (
                                <p className="text-gray-500">No appointments scheduled.</p>
                            ) : (
                                appointments.map(appt => (
                                    <li key={appt.id} className="flex justify-between items-center rounded-lg bg-gray-50 p-4 shadow-sm">
                                        <div>
                                            <h4 className="font-medium text-gray-800">{appt.date} at {appt.time}</h4>
                                            <p className="text-sm text-gray-600">{appt.description}</p>
                                        </div>
                                        <button onClick={() => handleDeleteAppointment(appt.id)} className="p-1 rounded-lg hover:bg-gray-100">
                                            <Trash2 />
                                        </button>
                                    </li>
                                ))
                            )}
                        </ul>
                    </div>
                </div>
            );
        };

        const CaseSummarySection = ({ patient }) => {
            const { db, userId } = useContext(AppContext);
            const [sources, setSources] = useState([]);
            const [newSource, setNewSource] = useState('');
            const [summary, setSummary] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            useEffect(() => {
                if (!db || !userId || !patient) return;
                const sourcesCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/sources`;
                const sourcesRef = collection(db, sourcesCollectionPath);
                const q = query(sourcesRef);
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const sourcesList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setSources(sourcesList);
                }, (error) => {
                    console.error("Error fetching sources:", error);
                });
                return () => unsubscribe();
            }, [db, userId, patient]);

            const handleAddSource = async () => {
                if (!newSource.trim()) return;
                try {
                    const sourcesCollectionPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/sources`;
                    await addDoc(collection(db, sourcesCollectionPath), { content: newSource, timestamp: new Date() });
                    setNewSource('');
                } catch (e) {
                    console.error("Error adding source: ", e);
                }
            };
            const handleDeleteSource = async (sourceId) => {
                try {
                    const sourceDocPath = `artifacts/${appId}/users/${userId}/patients/${patient.id}/sources/${sourceId}`;
                    await deleteDoc(doc(db, sourceDocPath));
                } catch (e) {
                    console.error("Error deleting source: ", e);
                }
            };
            const generateSummary = async () => {
                setIsLoading(true);
                setSummary('Generating summary...');
                const allSources = sources.map(s => s.content).join("\n\n");
                const systemPrompt = "You are a professional medical assistant. Generate a concise, single-paragraph summary of a patient's case based on the provided text sources (e.g., notes, lab results, emails, letters). Focus on key clinical details, diagnosis, and treatment history. Do not include opinions or information outside of the provided context.";
                const userQuery = `Summarize the following information for a patient named ${patient.name} with the diagnosis of ${patient.diagnosis}:\n\n${allSources}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating summary. Please try again.";
                    setSummary(text);
                } catch (error) {
                    console.error("API call failed:", error);
                    setSummary("Failed to generate summary due to an API error.");
                } finally {
                    setIsLoading(false);
                }
            };
            const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
            return (
                <div className="space-y-6">
                    <div className="rounded-lg bg-gray-50 p-6 shadow-sm">
                        <h3 className="text-xl font-semibold text-gray-800">Add Data Sources</h3>
                        <p className="mt-1 text-sm text-gray-500">Paste in information from emails, notes, or lab results.</p>
                        <div className="flex space-x-2 mt-4">
                            <textarea
                                value={newSource}
                                onChange={(e) => setNewSource(e.target.value)}
                                rows="4"
                                placeholder="Paste text from a document or email here..."
                                className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500"
                            />
                        </div>
                        <button onClick={handleAddSource} className="mt-3 w-full rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">Add Source</button>
                    </div>
                    <div className="rounded-lg bg-white p-6 shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold text-gray-800">Generated Summary</h3>
                            <button onClick={generateSummary} disabled={isLoading} className={`rounded-lg px-4 py-2 text-white font-medium transition-colors ${isLoading ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}`}>
                                {isLoading ? 'Generating...' : 'Generate Summary'}
                            </button>
                        </div>
                        <p className="mt-2 text-gray-800 whitespace-pre-wrap">{summary || "Click 'Generate Summary' to create a concise overview of the patient's case."}</p>
                        <div className="mt-6">
                            <h4 className="text-md font-medium text-gray-600 mb-2">Source Materials:</h4>
                            <ul className="space-y-2">
                                {sources.map(source => (
                                    <li key={source.id} className="flex justify-between items-start rounded-lg bg-gray-50 p-3 shadow-sm">
                                        <p className="text-sm text-gray-800">{source.content.substring(0, 100)}...</p>
                                        <button onClick={() => handleDeleteSource(source.id)} className="p-1 rounded-lg hover:bg-gray-100">
                                            <Trash2 />
                                        </button>
                                    </li>
                                ))}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsForm = ({ doctorInfo, setDoctorInfo, setView }) => {
            const handleChange = (e) => {
                const { id, value } = e.target;
                setDoctorInfo({ ...doctorInfo, [id]: value });
            };
            const handleSubmit = (e) => {
                e.preventDefault();
                setView('details');
            };
            return (
                <div className="rounded-xl bg-white shadow-lg">
                    <div className="p-6">
                        <h2 className="text-2xl font-semibold">Doctor Information</h2>
                        <p className="mt-1 text-sm text-gray-500">
                            Update your name and credentials to appear on prescriptions and documents.
                        </p>
                    </div>
                    <form onSubmit={handleSubmit}>
                        <div className="space-y-4 p-6 pt-0">
                            <div>
                                <label htmlFor="name" className="mb-1 block text-sm font-medium text-gray-700">Full Name</label>
                                <input id="name" type="text" value={doctorInfo.name} onChange={handleChange} required className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" />
                            </div>
                            <div>
                                <label htmlFor="credentials" className="mb-1 block text-sm font-medium text-gray-700">Credentials</label>
                                <input id="credentials" type="text" value={doctorInfo.credentials} onChange={handleChange} required className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" />
                            </div>
                            <div>
                                <label htmlFor="contact" className="mb-1 block text-sm font-medium text-gray-700">Contact Information</label>
                                <input id="contact" type="text" value={doctorInfo.contact} onChange={handleChange} required className="block w-full rounded-md border border-gray-300 px-3 py-2 text-gray-900 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50" />
                            </div>
                        </div>
                        <div className="flex justify-end p-6">
                            <button type="submit" className="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700">Save Changes</button>
                        </div>
                    </form>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <AppProvider>
                <App />
            </AppProvider>
        );
    </script>
</body>
</html>
